version: '3'

vars:
  IMAGE_NAME: realgan
  IMAGE_TAG: latest
  CONTAINER_NAME: realgan

tasks:
  setup:
    cmds:
      - mkdir -p input output
      - echo "Checking audit rules..."
      - |
        if ! sudo auditctl -l | grep -q "/usr/bin/docker"; then
          sudo auditctl -w /usr/bin/docker -k docker-audit
        fi

  build:
    cmds:
      - docker build -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} .

  scan:
    cmds:
      - dnf install -y trivy
      - trivy image {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  run:
    cmds:
      - |
        docker run --rm \
          --name {{.CONTAINER_NAME}} \
          --security-opt seccomp=seccomp-profile.json \
          --security-opt label=type:container_t \
          --read-only \
          --device nvidia.com/gpu=all \
          --volume ./input:/home/realgan/input:ro \
          --volume ./output:/home/realgan/output:rw \
          {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  monitor:
    cmds:
      - docker stats {{.CONTAINER_NAME}}
      - nvidia-smi

  logs:
    cmds:
      - docker logs --follow {{.CONTAINER_NAME}}

  audit:
    cmds:
      - sudo ausearch -k docker-audit

  gpu-test:
    cmds:
      - |
        docker run --rm \
          --device nvidia.com/gpu=all \
          nvidia/cuda:11.8.0-base-ubuntu22.04 \
          nvidia-smi
